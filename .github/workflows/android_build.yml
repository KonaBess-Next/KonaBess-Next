name: Android Build & Pre-Release

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Decode Keystore
      run: |
        if [ ! -z "${{ secrets.SIGNING_KEY }}" ]; then
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > ${{ github.workspace }}/keystore.jks
          echo "âœ… Keystore decoded from secrets"
        else
          echo "âš ï¸ No SIGNING_KEY secret found. Release build might fail or be unsigned if configured to verify."
          # Fallback or error handling if strictly required
        fi
      
    - name: Build Release APK
      run: |
        # Use secrets if available, otherwise just build (which might fail signing if strict)
        if [ ! -z "${{ secrets.SIGNING_KEY }}" ]; then
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=${{ github.workspace }}/keystore.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEY_STORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            --stacktrace
        else
           echo "âš ï¸ Building without signing injection"
           ./gradlew assembleRelease --stacktrace
        fi
        echo "âœ… Release APK built"

    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
      
    - name: Optimize APK with zipalign
      run: |
        # Find and optimize APKs
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)
        if [ -n "$RELEASE_APK" ]; then
          ANDROID_HOME="${ANDROID_HOME:-/usr/local/lib/android/sdk}"
          BUILD_TOOLS_VERSION=$(ls -1 "$ANDROID_HOME/build-tools" | sort -V | tail -1)
          ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          
          if [ -f "$ZIPALIGN" ]; then
            ALIGNED_APK="${RELEASE_APK%.apk}-aligned.apk"
            "$ZIPALIGN" -v 4 "$RELEASE_APK" "$ALIGNED_APK"
            mv "$ALIGNED_APK" "$RELEASE_APK"
            echo "âœ… APK optimized with zipalign"
          fi
        fi
        
    - name: Get version name
      id: version
      run: |
        # Adjusted for Groovy DSL in app/build.gradle
        VERSION=$(grep -oP "versionName\s*=\s*['\"]\K[^'\"]+" app/build.gradle || echo "1.0.0")
        BUILD_NUMBER=${{ github.run_number }}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "build=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "tag=v${VERSION}-build${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        
    - name: Rename and prepare APK files
      run: |
        VERSION=${{ steps.version.outputs.version }}
        BUILD=${{ steps.version.outputs.build }}
        
        # Check files before rename
        echo "Listing debug directory:"
        ls -R app/build/outputs/apk/debug/ || echo "Debug directory not found or empty"
        
        # Rename Debug APK - handle both universal and split APKs
        DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" ! -name "output-metadata.json" -type f | head -1)
        if [ -n "$DEBUG_APK" ]; then
          mv "$DEBUG_APK" "app/build/outputs/apk/debug/KonaBessNext-v${VERSION}-build${BUILD}-debug.apk"
          echo "Debug APK renamed successfully: $DEBUG_APK -> KonaBessNext-v${VERSION}-build${BUILD}-debug.apk"
        else
          echo "Warning: No debug APK found. Debug APK will not be included."
        fi
        
        # Handle Release APK
        # Priority: Look for universal APK first, then fallback to split APK
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*universal-release.apk" -type f | head -1)
        if [ -z "$RELEASE_APK" ]; then
             RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -1)
        fi
        
        if [ -n "$RELEASE_APK" ]; then
           mv "$RELEASE_APK" "app/build/outputs/apk/release/KonaBessNext-v${VERSION}-build${BUILD}-release.apk"
           echo "Release APK renamed successfully: $RELEASE_APK"
        fi
        
        # Show APK sizes
        echo ""
        echo "APK Sizes:"
        ls -lh app/build/outputs/apk/debug/*.apk 2>/dev/null || true
        ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null || true

    - name: VirusTotal Scan
      id: virustotal
      uses: crazy-max/ghaction-virustotal@v4
      if: github.event_name == 'push'
      with:
        vt_api_key: ${{ secrets.VT_API_KEY }}
        files: |
          app/build/outputs/apk/release/*.apk
          app/build/outputs/apk/debug/*.apk

    - name: Parse VirusTotal Results
      id: vt_parsed
      if: github.event_name == 'push' && steps.virustotal.outputs.analysis != ''
      run: |
        # Parse the comma-separated analysis output into formatted list
        ANALYSIS="${{ steps.virustotal.outputs.analysis }}"
        echo "Raw analysis: $ANALYSIS"
        
        # Format as markdown bullet list
        VT_RESULTS=""
        IFS=',' read -ra ENTRIES <<< "$ANALYSIS"
        for entry in "${ENTRIES[@]}"; do
          # entry format: filename=url
          FILENAME=$(echo "$entry" | cut -d'=' -f1 | xargs basename)
          URL=$(echo "$entry" | cut -d'=' -f2-)
          VT_RESULTS="${VT_RESULTS}- [${FILENAME}](${URL})\n"
        done
        
        # Use delimiter for multiline output
        echo "vt_results<<EOF" >> $GITHUB_OUTPUT
        echo -e "$VT_RESULTS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Delete old pre-releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      if: github.event_name == 'push'
      with:
        keep_latest: 5
        delete_tags: true
        delete_prerelease_only: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Pre-Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'push'
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Build ${{ steps.version.outputs.version }} (${{ steps.version.outputs.build }})
        body: |
          ## Automated Build
          
          **Version:** ${{ steps.version.outputs.version }}
          **Build Number:** ${{ steps.version.outputs.build }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          
          ### Artifacts
          - **Release APK**: Optimized and signed production build.
          - **Debug APK**: For testing with detailed logs.
          
          ### Security Scan
          **VirusTotal Scan Results:**
          ${{ steps.vt_parsed.outputs.vt_results }}
          
          ### Build Information
          This is an automated pre-release build.
          
          ### Changelog
          ${{ github.event.head_commit.message }}
          
          ---
          Built automatically by GitHub Actions
        draft: false
        prerelease: true
        files: |
          app/build/outputs/apk/debug/KonaBessNext-*.apk
          app/build/outputs/apk/release/KonaBessNext-*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Debug APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: Upload Release APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: Cleanup Keystore
      if: always()
      run: rm -f ${{ github.workspace }}/keystore.jks
        
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build | ${{ steps.version.outputs.build }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Tag | ${{ steps.version.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ APK Sizes" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -lh app/build/outputs/apk/debug/*.apk 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
        ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
